define(function(e){function t(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function n(){return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}var i=e("underscore"),r=e("$"),o=e("backbone");return o.LocalStorage=window.Store=function(e){this.name=e;var t=this.localStorage().getItem(this.name);this.records=t&&t.split(",")||[]},i.extend(o.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(e){return e.id||(e.id=n(),e.set(e.idAttribute,e.id)),this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e)),this.records.push(""+e.id),this.save(),this.find(e)},update:function(e){return this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e)),i.include(this.records,""+e.id)||this.records.push(""+e.id),this.save(),this.find(e)},find:function(e){return this.jsonData(this.localStorage().getItem(this.name+"-"+e.id))},findAll:function(){return i(this.records).chain().map(function(e){return this.jsonData(this.localStorage().getItem(this.name+"-"+e))},this).compact().value()},destroy:function(e){return e.isNew()?!1:(this.localStorage().removeItem(this.name+"-"+e.id),this.records=i.reject(this.records,function(t){return t===""+e.id}),this.save(),e)},localStorage:function(){return localStorage},jsonData:function(e){return e&&JSON.parse(e)}}),o.LocalStorage.sync=window.Store.sync=o.localSync=function(e,t,n){var i,a,s=t.localStorage||t.collection.localStorage,l=r.Deferred&&r.Deferred();try{switch(e){case"read":i=void 0!=t.id?s.find(t):s.findAll();break;case"create":i=s.create(t);break;case"update":i=s.update(t);break;case"delete":i=s.destroy(t)}}catch(u){a=u.code===DOMException.QUOTA_EXCEEDED_ERR&&0===window.localStorage.length?"Private browsing is unsupported":u.message}return i?(n&&n.success&&("0.9.10"===o.VERSION?n.success(t,i,n):n.success(i)),l&&l.resolve(i)):(a=a?a:"Record Not Found",n&&n.error&&("0.9.10"===o.VERSION?n.error(t,a,n):n.error(a)),l&&l.reject(a)),n&&n.complete&&n.complete(i),l&&l.promise()},o.ajaxSync=o.sync,o.getSyncMethod=function(e){return e.localStorage||e.collection&&e.collection.localStorage?o.localSync:o.ajaxSync},o.sync=function(e,t,n){return o.getSyncMethod(t).apply(this,[e,t,n])},o.LocalStorage});