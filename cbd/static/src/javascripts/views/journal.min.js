define(function(e,t,n){var o=e("underscore"),a=e("backbone"),i=e("../vendors/util"),r=e("jquery"),l=2,s=i.WaterFall,d=i.Date,u=i.LOAD,c=!1,h=r(window),m=(h.height(),r(".header").height()),p=a.View.extend({className:"journalView",initialize:function(){var t=this;t.queryObj=o.extend({type:"index"},arguments[0].query||{}),t.mouseMoveObj={flag:!1,moveSpace:5,start:{x:0,y:0}},t.itemCollection=new(e("../collections/item")),t.itemView=e("./item"),t.titleView=e("./title"),t.titleModel=new(e("../models/title")),t.journalModel=new(e("../models/journal")),t.waterObj=new s(l),t.$el=r(t.el),t.contentObj=r('<div class="journalContainer"></div>').appendTo(t.$el),t.journalTitleObj=r('<div class="journalTitle"></div>').appendTo(t.contentObj),t.journalContentObj=r('<div class="journalContent"></div>').appendTo(t.contentObj).append(t.waterObj.makeColHtml()),t.waterFallObj=t.journalContentObj.find(".waterCol"),c||(c=!0,i.setWaterFalColWidth(r(t.waterFallObj[0]).width())),t.contentObj.on("vmousemove vmousedown vmouseup vmouseout",function(){t.setBarStatue.apply(t,arguments)}),t.fixedBarObjs=r("body").find(".fixedBar"),t.itemCollection.bind("add",t.addOne,t),t.itemCollection.bind("reset",t.addAll,t),t.firstLoad(),t.scrollHandler(),t.journalModel.bind("change",t.render,this)},firstLoad:function(){var e=this;e.fetchData(function(t,n){if(!t){var o=n[1];o.journal&&(e.renderTitle(o),e.renderItems(o))}})},events:{"vclick .journalContainer":"preventDefault"},fetchData:function(e){var t=this;u.show(),t.journalModel.fetch({data:t.queryObj,success:function(){e(null,arguments),u.hide()},error:function(){alert("获取数据失败,请检查网络"),console.log("+++++++++++++++++++"),console.log(window.appConfig.appHost),console.log(JSON.stringify(t.queryObj)),console.log(t.journalModel.url),console.log("------------------"),e({err:"获取数据失败"},arguments),u.hide()}})},refreshView:function(){var e=this;e.fetchData(function(t,n){if(!t){var o=n[1];o.journal&&(e.journalTitleObj.html(""),e.waterFallObj.html(""),e.renderTitle(o),e.renderItems(o))}})},render:function(){return this},renderTitle:function(e){var t=this,n=e.journal.tle,o=e.journal._id,a=new Date(e.journal.pubTime||e.journal.updatedAt),i=d.getEnglishMonth(a.getMonth()),r=n.indexOf("】"),l=n.slice(0,r+1),s=n.slice(r+1);t.titleModel.set({_id:o,bTitle:l,title:s,month:i,date:a.getDate()});var u=new t.titleView({model:t.titleModel});return t.journalTitleObj.append(u.render().el),t},renderItems:function(e){var t=e.journal.items,n=this,a=o.filter(t,function(e){return e.pic_size});n.itemCollection.reset(),n.itemCollection.add(a)},preventDefault:function(){return this.showBar(),!1},setBarStatue:function(e){var t=this;switch(e.type){case"vmousedown":return t.mouseMoveObj.flag=!0,t.mouseMoveObj.start.x=e.pageX,t.mouseMoveObj.start.y=e.pageY,!1;case"vmousemove":return m>=h.scrollTop()?t.showBar():t.mouseMoveObj.flag&&(e.pageY-t.mouseMoveObj.start.y>t.mouseMoveObj.moveSpace?t.showBar():t.hideBar()),!1;case"vmouseup":case"vmouseout":return t.mouseMoveObj.flag=!1,!1}return!1},scrollHandler:function(){var e=this;h.on("scroll",function(){m>=h.scrollTop()&&e.showBar()})},showBar:function(){this.fixedBarObjs.stop().show()},hideBar:function(){this.fixedBarObjs.stop().hide()},addOne:function(e){var t=this,n=new t.itemView({model:e});r(t.waterFallObj[t.waterObj.getMinIndex()]).append(n.render().el),t.waterObj.pushItem(e.toJSON().pic_size.h)},addAll:function(){var e=this;e.itemCollection.each(function(){e.addOne.apply(e,arguments)})}});n.exports=p});