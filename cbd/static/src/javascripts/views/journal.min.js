define(function(e,t,n){var i=e("underscore"),o=e("backbone"),r=e("../vendors/util"),a=e("jquery"),s=2,l=r.WaterFall,c=r.Date,u=r.LOAD,d=!1,f=a(window),p=(f.height(),a(".header").height()),h=o.View.extend({className:"journalView",initialize:function(){var t=this;t.queryObj=i.extend({type:"index"},arguments[0].query||{}),t.mouseMoveObj={flag:!1,moveSpace:5,start:{x:0,y:0}},t.itemCollection=new(e("../collections/item")),t.itemView=e("./item"),t.titleView=e("./title"),t.titleModel=new(e("../models/title")),t.journalModel=new(e("../models/journal")),t.waterObj=new l(s),t.$el=a(t.el),t.contentObj=a('<div class="journalContainer"></div>').appendTo(t.$el),t.journalTitleObj=a('<div class="journalTitle"></div>').appendTo(t.contentObj),t.journalContentObj=a('<div class="journalContent"></div>').appendTo(t.contentObj).append(t.waterObj.makeColHtml()),t.waterFallObj=t.journalContentObj.find(".waterCol"),d||(d=!0,r.setWaterFalColWidth(a(t.waterFallObj[0]).width())),t.contentObj.on("vmousemove vmousedown vmouseup vmouseout",function(){t.setBarStatue.apply(t,arguments)}),t.fixedBarObjs=a("body").find(".fixedBar"),t.itemCollection.bind("add",t.addOne,t),t.itemCollection.bind("reset",t.addAll,t),t.firstLoad(),t.scrollHandler(),t.journalModel.bind("change",t.render,this)},firstLoad:function(){var e=this;e.fetchData(function(t,n){if(!t){var i=n[1];i.journal&&(e.renderTitle(i),e.renderItems(i))}})},events:{"vclick .journalContainer":"preventDefault"},fetchData:function(e){var t=this;u.show(),t.journalModel.fetch({data:t.queryObj,success:function(){e(null,arguments),u.hide()},error:function(){alert("获取数据失败,请检查网络"),console.log("+++++++++++++++++++"),console.log(window.appConfig.appHost),console.log(JSON.stringify(t.queryObj)),console.log(t.journalModel.url),console.log("------------------"),e({err:"获取数据失败"},arguments),u.hide()}})},refreshView:function(){var e=this;e.fetchData(function(t,n){if(!t){var i=n[1];i.journal&&(e.journalTitleObj.html(""),e.waterFallObj.html(""),e.renderTitle(i),e.renderItems(i))}})},render:function(){return this},renderTitle:function(e){var t=this,n=e.journal.tle,i=e.journal._id,o=new Date(e.journal.pubTime||e.journal.updatedAt),r=c.getEnglishMonth(o.getMonth()),a=n.indexOf("】"),s=n.slice(0,a+1),l=n.slice(a+1);t.titleModel.set({_id:i,bTitle:s,title:l,month:r,date:o.getDate()});var u=new t.titleView({model:t.titleModel});return t.journalTitleObj.append(u.render().el),t},renderItems:function(e){var t=e.journal.items,n=this,o=i.filter(t,function(e){return e.pic_size});n.itemCollection.reset(),n.itemCollection.add(o)},preventDefault:function(){return this.showBar(),!1},setBarStatue:function(e){var t=this;switch(e.type){case"vmousedown":return t.mouseMoveObj.flag=!0,t.mouseMoveObj.start.x=e.pageX,t.mouseMoveObj.start.y=e.pageY,!1;case"vmousemove":return p>=f.scrollTop()?t.showBar():t.mouseMoveObj.flag&&(e.pageY-t.mouseMoveObj.start.y>t.mouseMoveObj.moveSpace?t.showBar():t.hideBar()),!1;case"vmouseup":case"vmouseout":return t.mouseMoveObj.flag=!1,!1}return!1},scrollHandler:function(){var e=this;f.on("scroll",function(){p>=f.scrollTop()&&e.showBar()})},showBar:function(){this.fixedBarObjs.stop().show()},hideBar:function(){this.fixedBarObjs.stop().hide()},addOne:function(e){var t=this,n=new t.itemView({model:e});a(t.waterFallObj[t.waterObj.getMinIndex()]).append(n.render().el),t.waterObj.pushItem(e.toJSON().pic_size.h)},addAll:function(){var e=this;e.itemCollection.each(function(){e.addOne.apply(e,arguments)})}});n.exports=h});